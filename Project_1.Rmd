---
title: "Project_1"
output: 
  html_document:
    toc: true
    toc_float: true
---
## 0. Install required packages

```{r required packages installation, message=FALSE, results='hide'}
pckgs <- c('dplyr', 'ggplot2', 'reshape2', 'ggsignif', 'factoextra')
for(i in pckgs){
  if(!require(i, character.only = T)){
    install.packages(i, dependencies = T)
    library(i)
  }
}
```

## 1. User function combining multiple .csv files into one dataframe

*unite_multiple csv* function takes an absolute path to directory with files as an input. Basically, it creates a list of all .csv files in this directory and applies *read.csv* over them. As columns can be of different types, it converts all columns to factors to prevent an error when *bind.rows* is called. Resulting dataframe is assigned to global variable mussels_rawdata.

```{r unite_csv, echo=T}
unite_csv <- function(path_to_files){
  files_list <- list.files(path=path_to_files, pattern='*.csv')
  abs_paths <- paste0(path_to_files, files_list)
  mussels_rawdata <<- lapply(abs_paths, read.csv, stringsAsFactors = T, sep = ',') %>% 
    lapply(function(df) mutate_if(df, is.numeric, as.factor)) %>% 
    bind_rows
}
```

Let's try to apply this function:

```{r function call, echo=T}
unite_csv('/media/chorzow/Data/current_projects/bioinf_institute/R/data/Project_1/Data/')
```

Everything works fine.

## 2. Removing aberrant observations and EDA

### 2.1. Removing aberrant observations

Let's take a quick look on our data:

```{r first glimpse}
str(mussels_rawdata)
```

I thought that second variable's name is too long so I decided to rename it into "Sex":

```{r renaming variable}
names(mussels_rawdata)[2] <- 'Sex'
str(mussels_rawdata)
```

Moreover, it seems that there are variables that contain badly measured data. For example, there are 6 levels in Sex variable instead of 3. One of these levels is "three", so I decided to check whether such events occur in other variables.

```{r catching aberrations}
lapply(mussels_rawdata, function(x) grep("[[:alpha:]]+", levels(x)))
```

Seems like there are some aberrations in variables **Rings**, **Sex**, **Length** and **Viscera_weight**. We need to take a look and do something with them:

```{r closer look at aberrations}
levels(mussels_rawdata$Rings)[29]
levels(mussels_rawdata$Sex)[c(4:6)]
levels(mussels_rawdata$Length)[135]
levels(mussels_rawdata$Viscera_weight)[275]
```

Everything but the last case appears to be aberrations. We can substitute aberrations in variables **Rings** and **Sex** with numbers. Aberration in **Length** can be substituted with NA. Finally, aberration in **Viscera_weight** is basically not an aberration but a scientific notation of a regular number. It won't be considered as aberration after conversion to numeric type.

```{r substitution of aberrations}
mussels_rawdata[which(mussels_rawdata$Rings == 'nine'), 1] <- 9
mussels_rawdata[which(mussels_rawdata$Sex == 'three'), 2] <- 3
mussels_rawdata[which(mussels_rawdata$Sex == 'one'), 2] <- 1
mussels_rawdata[which(mussels_rawdata$Sex == 'male'), 2] <- 1
mussels_rawdata[which(mussels_rawdata$Length == "No data! I forgot to mesure it!("), 3] <- NA
```

Finally, let's do something with NA values in data. First, we should check how many NAs we've got:

```{r how many nas}
sum(is.na(mussels_rawdata))
```

There are two main approaches to handling NAs:
1. One can simply get rid of obseravtions that contain them. This approach can be inefficient when there are too many NAs in the data, so one must be careful with it.
2. We can also substitute NAs with some other value (mean, zero, some predicted value, etc). New values can affect our mean, SD and other statistics though. Hence, this approach can change the results of statistical tests and other manipulations with data more than filtering such observations out.

Since there are only 21 NA values (it is relatively small number considering the fact that we have 4177 observations in total), I decided to filter out NAs.

```{r omit na}
mussels_rawdata <- na.omit(mussels_rawdata)
```

To perform subsequent manipulations on data, its columns should be converted to numeric (except for Sex variable since it's basically a factor):

```{r convert data to numeric, echo = T, include=F}
mussels_rawdata[,-2] <- lapply(mussels_rawdata[,-2], function(x) as.numeric(levels(x))[x])
mussels_rawdata <- droplevels(mussels_rawdata)
```

### 2.2. EDA
Let's take a look at our data:

```{r glimpse on tidy data}
str(mussels_rawdata)
```

For basic visualization of all variables and relationships between them, I used *plot* function:

```{r basic EDA plot}
plot(mussels_rawdata)
```

Seems like there are some outliers (at least in **Height** variable). To examine them more thoroughly, I made a series of boxplots:

```{r boxplots for outliers visualization, message=F}
ggplot(data = reshape2::melt(mussels_rawdata), aes(x = Sex, y = value, fill = Sex)) + 
  geom_boxplot() + 
  facet_wrap(~variable, scales = 'free') + theme_bw() + xlab('') + ylab('') + ggtitle('Outliers visualization') +
  scale_fill_discrete(labels = c('Male', 'Female', 'Juvenile'))
```

I also visualized distributions of each variable:

```{r distributions, message=FALSE}
ggplot(data = reshape2::melt(mussels_rawdata), aes(x = value)) + 
  geom_density() + 
  facet_wrap(~variable, scales = 'free') + theme_bw() + xlab('') + ylab('') + ggtitle('Distributions visualization')
```

It seems that all variables have non-normal distribution. One of the most interesting variables here is **Rings**. It seems that it contains the largest number of outliers. Let's check how many:

```{r outliers of Rings}
length(boxplot.stats(mussels_rawdata$Rings)$out)
```

So, there are almost 300 outliers. I think this number is too big to just filter all these observations out. Furthermore, we cannot substitute these values to mean or some predicted values because this variable is discrete, and this kind of substitution will make this variable continuous (we don't need that at all). Substitution to zeros will make a very negative impact on statistical tests and distribution of this variable. So my decision was to leave this variable as is but manage outliers in other variables. I decided to treat them with 1.5 * interquartile range because total number of outliers in other variables is about 200. That number is quite big and we don't want to lose this amount of data, as in case with Rings.

```{r filtering outliers}

filter_outliers <- function(x) {
  qntls <- quantile(x, c(.25, .75))
  x[x < (qntls[1] - 1.5 * IQR(x))] <- qntls[1] - 1.5 * IQR(x)
  x[x > (qntls[2] + 1.5 * IQR(x))] <- qntls[2] + 1.5 * IQR(x)
  x
}

mussels <- mussels_rawdata %>% 
  group_by(Sex) %>%
  mutate_at(vars(-Rings,-Sex), filter_outliers)
```

Now let's use *plot* function one more time to validate changes in variables' behaviour:

```{r plot without outliers}
plot(mussels)
```

**Note:** now it seems that variable Height displays nicer correlation with other variables compared to our previous result of using *plot* function.

Let's take a look at boxplots:

```{r boxplot filtered outliers, message=F}
ggplot(data = reshape2::melt(mussels), aes(x = Sex, y = value, fill = Sex )) + 
  geom_boxplot() + 
  facet_wrap(~variable, scales = 'free') + theme_bw() + xlab('') + ylab('') + ggtitle('Data with outliers filtered') + 
  scale_fill_discrete(labels = c('Male', 'Female', 'Juvenile'))
```

Finally, let's see if distributions of variables changed somehow:

```{r distributions without outliers, message=FALSE}
ggplot(data = reshape2::melt(mussels), aes(x = value)) + 
  geom_density() + 
  facet_wrap(~variable, scales = 'free') + theme_bw() + xlab('') + ylab('') + ggtitle('Distributions visualization - no outliers')
```

**Note:** outliers filtration certainly affected distributions of variables, especially Height. Now it even resembles normal distribution.

## 3. Mean and SD of Length for different sex

```{r task 3,message=F}
mussels %>% 
  group_by(Sex) %>% 
  summarise(Mean = mean(Length), SD = sd(Length))
```

## 4. Number of mussels with Height <= 0.165

```{r task 4}
noquote(paste0(as.character(length(which(mussels$Height <= 0.165)) / nrow(mussels) * 100), '%')) 
```

## 5. Length value that is more than 92% of all observations

```{r task 5}
quantile(mussels$Length, 0.92)
```

## 6. New variable - Length_z_scores

```{r task 6}
mussels$Length_z_scores <- scale(mussels$Length)
```

## 7. Compare diameter of mussels with 5 and 15 rings

Firstly, I made a subset of data for convenience. Variable Rings in this subset was converted to factor for proper comparison.

```{r subset for task 7}
task7 <- mussels %>% 
  filter(Rings == 15 | Rings == 5) %>% 
  mutate(Rings = as.factor(Rings)) %>% 
  select(Rings, Diameter) %>% 
  group_by(Rings)
```

After subsetting, I checked whether the distribution of Diameter variable in this subset is normal or not, using Shapiro-Wilk test.

```{r shapiro}
shapiro.test(task7$Diameter)
```

To visually check the normality of the data, let's draw Q-Q plot.

```{r diameter qqplot}
qqnorm(task7$Diameter)
qqline(task7$Diameter, col = "blue", lwd = 2)
```

Since the distribution is far from normal (both statistical tests and visualization tell us that), it seems we have to use non-parametric statistics. In this case, we have two independent groups, therefore, Mann-Whitney U Test should be used. 
Null hypothesis: mussels with 5 and 15 rings come from the same population (in our case - have the same median).
Alternative hypothesis: mussels with 5 and 15 rings come from different populations (in our case - have different medians).

```{r mann-whitney test}
wilcox.test(data = task7, Diameter~Rings, paired = F)
```

**Conclusion:** Null hypothesis is rejected. Alternative hypothesis is accepted: it can be said that diameter of mussels with 5 rings is different from diameter of mussels with 15 rings (we don't know which is larger because two-tailed test was used).

Let's see how our results look like:

```{r boxplot for task 7}
ggplot(task7, aes(Rings, Diameter, fill = Rings)) + geom_boxplot() + theme_bw() + 
  geom_signif(comparisons = list(c('5', '15')), map_signif_level = TRUE, y_position = 0.62) +
  ggtitle("Diameter of mussels with 5 and 15 rings") 
```

Looking at this graph, it can be concluded that diameter of mussels with 5 rings is significantly less than diameter of mussels with 15 rings.

## 8. Correlations between Diameter and Whole_weight

Looking at EDA results, I can assume that these variables could correlate with each other. To check that, I used Pearson correlation method.

```{r correlation test}
cor.test(mussels$Diameter, mussels$Whole_weight)
```

Indeed, according to Pearson's correlation, Diameter and Whole_weight demonstrate strong positive statistically significant correlation between them. It can be visualized with a plot like this:

```{r correlation plot, warning=F, message=F}
ggplot(data = mussels, aes(Diameter, Whole_weight)) + geom_point() + geom_smooth(method=lm) + theme_bw() + ylab("Whole weight") + ylim(0, 3) + ggtitle("Correlation of diameter and whole weight of mussel")
```

## 9. Further manipulations

### 9.1. Principal Component Analysis (PCA)

I decided to perform a PCA to estimate clusterization of data in relation to sex of mussels and visually check if different sexes are somehow different from each other. After using *prcomp* function and saving its summary to variable *pca_summary* that will be used hereinafter, percentage of variance explained by each PC was calculated. Then, percentage of variance explained by each PC was visualized on a scree plot. 

```{r pca}
mussels_pca <- prcomp(mussels[,-2], scale=T)
pca_summary <- summary(mussels_pca)
pca_var <- mussels_pca$sdev^2 
pca_var_per <- round(pca_var / sum(pca_var) * 100, 1) # convert variation into percentage
barplot(pca_var_per, main = 'Scree Plot', xlab = 'Principal Components', ylab = 'Percent Variation')
```

As we can see, first two PCs can explain decent amount of variance. Let's be more specific and see how much:

```{r percent of variation explained by first two PCs}
pca_summary$importance[3,c(1:2)]
```

Hence, total amount of variation explained by first two PCs, is about 95%, which is a good result. Let's visualize it in a PCA plot:

```{r pca plot}
fviz_pca_ind(mussels_pca, geom.ind = "point", pointshape = 21, 
             pointsize = 2, 
             fill.ind = mussels$Sex, 
             col.ind = "black", 
             addEllipses = TRUE,
             label = "var",
             col.var = "black",
             repel = TRUE,
             legend.title = "Sex") +
  ggtitle("PCA-plot") + xlab(paste0("PC1 - ", pca_var_per[1], "%")) + ylab(paste0("PC2 - ", pca_var_per[2], "%")) + 
  theme(plot.title = element_text(hjust = 0.5))
```

As we can see, our data appear to be clustered into 3 intersecting clusters. Juvenile mussels(blue cluster) seem to be slightly more different from male and female individuals. It can be validated with boxplots that I made in EDA part: in every variable juvenile mussels display lower values than other two sexes. 

### 9.2. Whole_weight and Sex

I remember that one of the variables that you were especially interested in was Whole_weight. I decided to check if it differs depending on Sex of mussels. Let's check its distribution:

```{r distributions of Whole_weight}
shapiro.test(mussels$Whole_weight)
```

As in Task 7, distributions of variables are far from normal. Therefore, now we need to compare three independent groups with non-parametric distributions. To do this, I used Kruskal-Wallis test with subsequent pairwise comparisons with Benjamini-Hochberg correction.

```{r kruskal}
kruskal.test(Whole_weight ~ Sex, data = mussels)
```
```{r pairwise MW}
pairwise.wilcox.test(mussels$Whole_weight, mussels$Sex, p.adjust.method = 'BH', paired = F)
```

Surprisingly, there were significant differences between all groups of comparisons. Last thing we need is to visualize them:

```{r kruskal plot}
ggplot(data = mussels, aes(Sex, Whole_weight, fill = Sex)) + geom_boxplot() + 
  geom_signif(comparisons = list(c('2', '3')), map_signif_level = T, y_position = 2.3) +
  geom_signif(comparisons = list(c('1', '2')), map_signif_level = T, y_position = 2.5) +
  geom_signif(comparisons = list(c('1', '3')), map_signif_level = T, y_position = 2.7) +
  theme_bw() + scale_fill_discrete(labels = c('Male', 'Female', 'Juvenile')) + ylab('Whole weight') + 
  ggtitle('Whole weight of different sexes of mussels')
```